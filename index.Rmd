---
title: "Predicting EA Sports FIFA Team of the Season in Europe's Five Leagues"
output:
  html_document:
    toc: TRUE
    theme: yeti
    highlight: tango
---

```{r setup, echo = FALSE}
##knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, echo = FALSE}
library(tidyverse)
library(tidymodels)
library(lubridate)
library(vip)
library(stacks)
library(DALEX)
library(DALEXtra)
library(themis)
library(formattable)
library(kableExtra)
library(cowplot)
library(formattable)
library(kableExtra)
library(cvms)
```

```{r base models, echo = FALSE}
fifa17_modeling <- readRDS("prem17mod")
fifa18_modeling <- readRDS("prem18mod")
fifa19_modeling <- readRDS("prem19mod")
fifa21_modeling <- readRDS("prem21mod")
fifa17_modeling_la_liga <- readRDS("laliga17mod")
fifa18_modeling_la_liga <- readRDS("laliga18mod")
fifa19_modeling_la_liga <- readRDS("laliga19mod")
fifa21_modeling_la_liga <- readRDS("laliga21mod")
ligue1_fifa17_modeling <- readRDS("ligue1_17mod")
ligue1_fifa18_modeling <- readRDS("ligue1_18mod")
ligue1_fifa19_modeling <- readRDS("ligue1_19mod")
fifa21_modeling_ligue1 <- readRDS("ligue1_21mod")
fifa17_modeling_serie_a <- readRDS("seriea17mod")
fifa18_modeling_serie_a <- readRDS("seriea18mod")
fifa19_modeling_serie_a <- readRDS("seriea19mod")
fifa21_modeling_serie_a <- readRDS("seriea21mod")
fifa17_modeling_bundesliga <- readRDS("bundesliga17mod")
fifa18_modeling_bundesliga <- readRDS("bundesliga18mod")
fifa19_modeling_bundesliga <- readRDS("bundesliga19mod")
fifa21_modeling_bundesliga <- readRDS("bundesliga21mod")
```







\
\







## Introduction

The video game FIFA, which is developed by Electronic Arts (EA) Sports, has become the most popular sports video game in the world in recent years, largely due to its game mode Ultimate Team. The objective of Ultimate Team is to build the best team possible through both buying and selling players, as well as buying packs of cards similarly to how people buy soccer trading cards in real life. Each player receives ratings in various categories based on their real life abilities, and each of these ratings factor into their overall rating. At the end of each season, EA Sports creates a Team of the Season (TOTS), where they select the best player at each position in each league from that season based on how they performed in real life. The players who receive TOTS cards also receive a boost to their overall rating to reflect their abilities in real life. Although most of their choices for TOTS are understandable, there are some choices that confuse and sometimes anger fans. Along with this, EA has never explained how they make their choices. Through the use of machine learning methods and predictive modeling, we aim to determine which variables are most important when choosing a player for TOTS, as well as predict the Team of the Season for Europe's top five leagues based on this season's statistics.






\
\





## Methods and Materials

**Materials**: We retrieved complete player datasets for FIFA 17, FIFA 18, and FIFA 19 from [here](https://www.kaggle.com/stefanoleone992/fifa-21-ultimate-team-players-and-prices-dataset). We retrieved real life statistics from the 2016-2017, 2017-2018, and 2018-2019 seasons from [fbref.com](https://fbref.com/en/). We did not use data from the 2019-2020 season because COVID-19 caused each season to prematurely end in March of 2020.
\


**Methods**: 
\
Using these data sets we went about predicting team of the season players using a Random Forest machine learning model. OTher models were tested, but we found that this method was the best. This makes many decision trees using the data to predict what players will be in the team of the season based upon the information that we feed into it. It then puts all of those trees together in order to make a decision on whether or not a player should be in the team of the season. We can then apply that model to data that it did not use in deciding how to decide whether or not a player is in the team of the season in order to check how good our model really is. 







\
\


```{r echo = FALSE}
prem_summarized <- prem_modeling %>% 
  summarize(Goals = round(mean(Gls, na.rm = T),2), Assists = round(mean(Ast, na.rm = T),2), `Non PK Goals` = round(mean(Non_PK_G, na.rm = T),2), PK = round(mean(PK, na.rm = T),2), `Team Rank` = round(mean(Rk, na.rm = T),2), `Minutes Per 90` = round(mean(Min, na.rm = T)/90,2) , `Goals SD` = round(sd(Gls, na.rm = T),2), `Assists SD` = round(sd(Ast, na.rm = T),2), `Non PK Goals SD` = round(sd(Non_PK_G, na.rm = T),2),`Team Rank SD` = round(sd(Rk, na.rm = T),2), `Minutes Per 90 SD` = round(sd(Min, na.rm = T)/90,2)) %>% 
  mutate(League = "Premier League") %>% 
  select(League, everything())

la_liga_summarized <- la_liga_modeling %>% 
    summarize(Goals = round(mean(Gls, na.rm = T),2), Assists = round(mean(Ast, na.rm = T),2), `Non PK Goals` = round(mean(Non_PK_G, na.rm = T),2), PK = round(mean(PK, na.rm = T),2), `Team Rank` = round(mean(Rk, na.rm = T),2), `Minutes Per 90` = round(mean(Min, na.rm = T)/90,2) , `Goals SD` = round(sd(Gls, na.rm = T),2), `Assists SD` = round(sd(Ast, na.rm = T),2), `Non PK Goals SD` = round(sd(Non_PK_G, na.rm = T),2),`Team Rank SD` = round(sd(Rk, na.rm = T),2), `Minutes Per 90 SD` = round(sd(Min, na.rm = T)/90,2)) %>% 
  mutate(League = "La Liga") %>% 
  select(League, everything())

ligue1_summarized <- ligue1_modeling %>% 
  summarize(Goals = round(mean(Gls, na.rm = T),2), Assists = round(mean(Ast, na.rm = T),2), `Non PK Goals` = round(mean(Non_PK_G, na.rm = T),2), PK = round(mean(PK, na.rm = T),2), `Team Rank` = round(mean(Rk, na.rm = T),2), `Minutes Per 90` = round(mean(Min, na.rm = T)/90,2) , `Goals SD` = round(sd(Gls, na.rm = T),2), `Assists SD` = round(sd(Ast, na.rm = T),2), `Non PK Goals SD` = round(sd(Non_PK_G, na.rm = T),2),`Team Rank SD` = round(sd(Rk, na.rm = T),2), `Minutes Per 90 SD` = round(sd(Min, na.rm = T)/90,2)) %>% 
  mutate(League = "Ligue 1") %>% 
  select(League, everything())

bundesliga_summarized <- bundesliga_modeling %>% 
  summarize(Goals = round(mean(Gls, na.rm = T),2), Assists = round(mean(Ast, na.rm = T),2), `Non PK Goals` = round(mean(Non_PK_G, na.rm = T),2), PK = round(mean(PK, na.rm = T),2), `Team Rank` = round(mean(Rk, na.rm = T),2), `Minutes Per 90` = round(mean(Min, na.rm = T)/90,2) , `Goals SD` = round(sd(Gls, na.rm = T),2), `Assists SD` = round(sd(Ast, na.rm = T),2), `Non PK Goals SD` = round(sd(Non_PK_G, na.rm = T),2),`Team Rank SD` = round(sd(Rk, na.rm = T),2), `Minutes Per 90 SD` = round(sd(Min, na.rm = T)/90,2)) %>% 
  mutate(League = "Bundesliga") %>%  
  select(League, everything())

serie_a_summarized <- serie_a_modeling %>% 
    summarize(Goals = round(mean(Gls, na.rm = T),2), Assists = round(mean(Ast, na.rm = T),2), `Non PK Goals` = round(mean(Non_PK_G, na.rm = T),2), PK = round(mean(PK, na.rm = T),2), `Team Rank` = round(mean(Rk, na.rm = T),2), `Minutes Per 90` = round(mean(Min, na.rm = T)/90,2) , `Goals SD` = round(sd(Gls, na.rm = T),2), `Assists SD` = round(sd(Ast, na.rm = T),2), `Non PK Goals SD` = round(sd(Non_PK_G, na.rm = T),2),`Team Rank SD` = round(sd(Rk, na.rm = T),2), `Minutes Per 90 SD` = round(sd(Min, na.rm = T)/90,2)) %>% 
  mutate(League = "Serie A") %>%  
  select(League, everything())

league_comparison <- rbind(prem_summarized, la_liga_summarized, ligue1_summarized, bundesliga_summarized, serie_a_summarized)

leagues_formatted <- formattable(league_comparison[1:5,1:12])

kable(leagues_formatted, align = c(rep("c", 12))) %>% 
  row_spec(0) %>% 
  kable_styling(full_width = F) %>% 
  add_header_above(c("Comparison of 5 Largest Global Soccer Leagues for Suspected KPIs (2017-2019)" = 12), background = "black", color = "white")
```



## English Premier League

```{r premmod1, echo = FALSE}
fifa19_modeling2 <- fifa19_modeling %>%
  mutate(Player = paste(Player, '19'))

fifa18_modeling2 <- fifa18_modeling %>%
  mutate(Player = paste(Player, '18'))

fifa17_modeling2 <- fifa17_modeling %>%
  mutate(Player = paste(Player, '17'))



prem_modeling <- fifa17_modeling2 %>% 
  bind_rows(fifa18_modeling2, fifa19_modeling2) %>% 
  mutate(revision = as.factor(revision), Nation = as.factor(Nation))
```

```{r premmod2, echo = FALSE}
prem_modeling %>% 
  select(where(is.numeric)) %>% 
  pivot_longer(cols = everything(),
               names_to = "variable", 
               values_to = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30) +
  facet_wrap(vars(variable), 
             scales = "free")
```

```{r echo = FALSE}}
theme_set(theme_cowplot())

prem_prop <- prem_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = Revision, fill = Revision)) +
  geom_bar() +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Revision", y = "Count", title = "Proportion of Revisions Within Premier League Dataset Selected for TOTS") +
  theme(plot.title = element_text(hjust = .25, size = 13.5)) +
  geom_vline(xintercept = 0, linetype = "dotted") 

prem_prop_logo <- ggdraw() + draw_image("https://www.fifplay.com/img/public/premier-league-2-logo.png", x = .42, y = .23, scale = .25) + 
  draw_plot(prem_prop)

prem_prop_logo
```




```{r premplot2, echo = FALSE}
prem_goals_density <- prem_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = Gls, fill = Revision)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Goals", y = "Density", title = "Density Plot of Goals Scored in Premier League Season by Revision Status", subtitle = "TOTS players tend to score goals more prolifically than their non-selected counterparts") + 
theme(plot.subtitle = element_text(hjust = -.35, size = 11), plot.title = element_text(hjust = .3, size = 13.5))

prem_goals_logo <- ggdraw() + draw_image("https://www.fifplay.com/img/public/premier-league-2-logo.png", x = .42, y = .2, scale = .25) + 
  draw_plot(prem_goals_density)

prem_goals_logo
```


```{r premplot3, echo = FALSE}
prem_tablepos_density <- prem_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = Rk, fill = Revision)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Table Position", y = "Density", title = "Density Plot of Premier League Table Position by Revision Status", subtitle = "Players on winning teams (lower table position) make up a substantial proportion of the Premier League TOTS dataset") + 
theme(plot.subtitle = element_text(hjust = .4, size = 8), plot.title = element_text(hjust = .1, size = 13.5))

prem_tablepos_logo <- ggdraw() + draw_image("https://www.fifplay.com/img/public/premier-league-2-logo.png", x = .42, y = .2, scale = .25) + 
  draw_plot(prem_tablepos_density)

prem_tablepos_logo
```

```{r premplot4, echo = FALSE}
prem_mppn_density <- prem_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = minutes_played_divided_by90, fill = Revision)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Total Minutes Played Dived by 90 (Full Games Played)", y = "Density", title = "Density Plot of Premier League Minutes Played (Per 90 Minutes) by Revision Status", subtitle = "Players who accrue more minutes per contest are more likely to be picked for Premier League TOTS") + 
theme(plot.subtitle = element_text(hjust = .45, size = 8), plot.title = element_text(hjust = .5, size = 11))

prem_mppn_logo <- ggdraw() + draw_image("https://www.fifplay.com/img/public/premier-league-2-logo.png", x = .42, y = .2, scale = .25) + 
  draw_plot(prem_mppn_density)

prem_mppn_logo
```

```{r premplot5, echo = FALSE}
prem_positions <- prem_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = position, fill = Revision)) +
  geom_bar(position = "identity") +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Position", y = "Count", title = "Positional Breakdown Within Premier League Dataset")

prem_positions_logo <- ggdraw() + draw_image("https://www.fifplay.com/img/public/premier-league-2-logo.png", x = .42, y = .22, scale = .25) + 
  draw_plot(prem_positions)

prem_positions_logo
```


```{r premmod3, echo = FALSE}
prem_modeling_outfield <- prem_modeling %>% 
  filter(position != "GK") %>% 
  filter(minutes_played_divided_by90 >= 19) %>% 
  mutate(position = ifelse(position == "RWB", "RB", ifelse(position == "LWB", "LB", position))) %>% 
  select(-Goals_allowed, -GA90, -SoTA, -Saves, -Save_percent, -W, -L, -D, -CS, -CS_percent, -Pkatt_against, -PKA, -PKsv, -Pk_Save_percent, -PKm)
```


```{r premmod4, echo = FALSE}
set.seed(494)
prem_split <- initial_split(prem_modeling_outfield, prop = .75, strata = "revision")
prem_training <- training(prem_split)
prem_testing <- testing(prem_split)
```

```{r message = FALSE, warning = FALSE, echo = FALSE}
prem_train_metrics <- prem_training %>% 
  mutate(Type = "Training") %>% 
  rename(Revision = revision) %>% 
  group_by(Revision, Type) %>% 
  summarize(Goals = mean(Gls, na.rm = T), Assists = mean(Ast, na.rm = T), `Non PK Goals` = mean(Non_PK_G, na.rm = T), PK = mean(PK, na.rm = T), `Team Rank` = mean(Rk, na.rm = T), `Minutes Per 90` = mean(Min, na.rm = T)/90 , `Goals SD` = sd(Gls, na.rm = T), `Assists SD` = sd(Ast, na.rm = T), `Non PK Goals SD` = sd(Non_PK_G, na.rm = T),`Team Rank SD` = sd(Rk, na.rm = T), `Minutes Per 90 SD` = sd(Min, na.rm = T)/90)

prem_test_metrics <- prem_testing %>% 
  mutate(Type = "Testing") %>% 
  rename(Revision = revision) %>% 
  group_by(Revision, Type) %>% 
  summarize(Goals = mean(Gls, na.rm = T), Assists = mean(Ast, na.rm = T), `Non PK Goals` = mean(Non_PK_G, na.rm = T), PK = mean(PK, na.rm = T), `Team Rank` = mean(Rk, na.rm = T), `Minutes Per 90` = mean(Min, na.rm = T)/90 , `Goals SD` = sd(Gls, na.rm = T), `Assists SD` = sd(Ast, na.rm = T), `Non PK Goals SD` = sd(Non_PK_G, na.rm = T),`Team Rank SD` = sd(Rk, na.rm = T), `Minutes Per 90 SD` = sd(Min, na.rm = T)/90)



prem_rebound_split <- rbind(prem_train_metrics, prem_test_metrics) %>% arrange(Revision)

prem_metrics_table <- formattable(prem_rebound_split[1:4,1:13])

kable(prem_metrics_table, align = c(rep('c', 1))) %>% 
  row_spec(0) %>% 
  kable_styling(full_width = F) %>% 
  add_header_above(c("Premier League Training and Testing Group Comparison for Suspected KPIs" = 13), background = "purple", color = "white")
```

```{r premranger1, echo = FALSE}
prem_ranger_recipe <- recipe(revision ~., data = prem_training) %>% 
  step_rm(Player, Nation, Squad, G_per90, A_per90, minutes_played_divided_by90, Attendance, Born) %>% 
  step_upsample(revision, over_ratio = .33) %>% 
  step_mutate_at(all_numeric(), fn = ~as.numeric(.))

prem_ranger_recipe %>% 
  prep(prem_training) %>% 
  juice()
```


```{r premranger2, echo = FALSE}
prem_ranger <- rand_forest(mtry = tune(), 
              min_n = tune(), 
              trees = 100) %>% 
  set_mode("classification") %>% 
  set_engine("ranger")

prem_ranger_wf <- 
  workflow() %>% 
  add_recipe(prem_ranger_recipe) %>% 
  add_model(prem_ranger) 

prem_ranger_wf
```


```{r premranger3, echo = FALSE}
set.seed(494)
prem_cv <- vfold_cv(prem_training, v = 5)

prem_rf_grid <- grid_regular(min_n(), finalize(mtry(), prem_training %>% select(-revision)), levels = 3)

ctrl_res <- control_stack_grid()

prem_ranger_cv <- prem_ranger_wf %>% 
  tune_grid(resamples = prem_cv,
           grid = prem_rf_grid,
           control = ctrl_res)

collect_metrics(prem_ranger_cv)
```


```{r premranger4, echo = FALSE}
prem_best1 <- prem_ranger_cv %>% 
  select_best(metric = "accuracy")

prem_ranger_final_wf<- prem_ranger_wf %>% 
  finalize_workflow(prem_best1)
```

```{r premranger5, echo = FALSE}
set.seed(494)
prem_ranger_fit <- prem_ranger_final_wf %>% 
  fit(prem_training)


prem_rf_explain <- 
  explain_tidymodels(
    model = prem_ranger_fit,
    data = prem_training %>% select(-revision), 
    y = as.numeric(prem_training$revision == "TOTS"),
    label = "rf"
  )
```

```{r premvip1, echo = FALSE}
prem_rf_var_imp <- 
  model_parts(
    prem_rf_explain
    )

plot(prem_rf_var_imp)
```



```{r premranger6, echo = FALSE}
prem_ranger_test <- prem_ranger_final_wf %>% 
  last_fit(prem_split)

prem_ranger_test %>% 
  collect_metrics()
```

```{r premconfuse1, echo = FALSE}
prem_preds1 <- prem_ranger_test %>% 
  collect_predictions()

prem_preds1 %>% 
  conf_mat(`revision`, .pred_class)
```


```{r premranger7, message = FALSE, echo = FALSE}
prem_ranger_test <- prem_testing %>% 
  bind_cols(predict(prem_ranger_fit, new_data = prem_testing, type = "prob")) %>% 
  bind_cols(predict(prem_ranger_fit, new_data = prem_testing)) 

prem_rf_preds <- prem_ranger_test %>% 
  conf_mat(revision, .pred_class)

prem_rf_ggconfusion <- autoplot(prem_rf_preds, type = "heatmap") + labs(title = "Confusion Matrix of Premier League Random Forest Model") + scale_fill_gradient(low = "blue", high = "red") + theme(plot.title = element_text(hjust = .5, size = 15))


prem_rf_final_confusion <- ggdraw() + draw_image("https://www.fifplay.com/img/public/premier-league-2-logo.png", x = -.43, y = .4, scale = .18) + 
  draw_plot(prem_rf_ggconfusion)

prem_rf_final_confusion 
```

```{r premconfuse2, echo = FALSE}
prem_ranger_test %>% 
  conf_mat(revision, .pred_class)
```

```{r premwrong1, echo = FALSE}
prem_ranger_test %>% 
  filter(revision != .pred_class)
```


```{r 21prem, echo = FALSE}
prem_modeling21 <- fifa21_modeling %>% 
  mutate(revision = as.factor(revision), Nation = as.factor(Nation), Age = as.integer(Age))
```

```{r 21premoutfield, echo = FALSE}
prem_modeling_outfield21 <- prem_modeling21 %>% 
  filter(position != "GK") %>% 
  filter(minutes_played_divided_by90 >= 19) %>% 
  mutate(position = ifelse(position == "RWB", "RB", ifelse(position == "LWB", "LB", position)))
```


```{r 21premranger1, echo = FALSE}
prem_ranger_test21 <- prem_modeling_outfield21 %>% 
  bind_cols(predict(prem_ranger_fit, new_data = prem_modeling_outfield21, type = "prob")) %>% 
  bind_cols(predict(prem_ranger_fit, new_data = prem_modeling_outfield21)) 
```

```{r, 21prempredictATT, echo = FALSE}
prem_ranger_test21 %>% 
  filter(position %in% c("ST", "RW", "CF", "LW")) %>% 
  arrange(desc(.pred_TOTS)) %>% 
  head(5)
```

```{r 21prempredictMID, echo = FALSE}
prem_ranger_test21 %>% 
  filter(position %in% c("CAM", "CM", "CDM", "LM", "RM")) %>% 
  arrange(desc(.pred_TOTS)) %>% 
  head(5)
```


```{r 21prempredictDEF, echo = FALSE}
prem_ranger_test21 %>% 
  filter(position %in% c("LB", "CB", "RB")) %>% 
  arrange(desc(.pred_TOTS)) %>% 
  head(5)
```

![Premier League Team of the Season](PremTOTS.jpg)










\
\




## La Liga (Spain)

```{r laligamod1, echo = FALSE}
fifa19_modeling_la_liga2 <- fifa19_modeling_la_liga %>%
  mutate(Player = paste(Player, '19'))

fifa18_modeling_la_liga2 <- fifa18_modeling_la_liga %>%
  mutate(Player = paste(Player, '18'))

fifa17_modeling_la_liga2 <- fifa17_modeling_la_liga %>%
  mutate(Player = paste(Player, '17'))



la_liga_modeling <- fifa17_modeling_la_liga2%>% 
  bind_rows(fifa18_modeling_la_liga2, fifa19_modeling_la_liga2) %>% 
  select(-Starts) %>% 
  mutate(revision = as.factor(revision), Nation = as.factor(Nation))
```

```{r laligamod2, echo = FALSE}
la_liga_modeling %>% 
  select(where(is.numeric)) %>% 
  pivot_longer(cols = everything(),
               names_to = "variable", 
               values_to = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30) +
  facet_wrap(vars(variable), 
             scales = "free")
```

```{r laligaplot1, echo = FALSE}
theme_set(theme_cowplot())
la_liga_prop <- la_liga_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = Revision, fill = Revision)) +
  geom_bar() +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Revision", y = "Count", title = "Proportion of Revisions Within La Liga Dataset Selected for TOTS") +
  theme(plot.title = element_text(hjust = .2, size = 13.5)) +
  geom_vline(xintercept = 0, linetype = "dotted") 
la_liga_prop_logo <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/commons/thumb/1/13/LaLiga.svg/1200px-LaLiga.svg.png", x = .42, y = .25, scale = .25) + 
  draw_plot(la_liga_prop)

la_liga_prop_logo
```


```{r laligaplot2, echo = FALSE}
la_liga_goals_density <- la_liga_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = Gls, fill = Revision)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Goals", y = "Density", title = "Density Plot of Goals Scored in La Liga Season by Revision Status", subtitle = "TOTS players tend to score goals more prolifically than their non-selected counterparts") + 
theme(plot.subtitle = element_text(hjust = 0, size = 11), plot.title = element_text(hjust = .1, size = 13.5))

la_liga_goals_logo <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/commons/thumb/1/13/LaLiga.svg/1200px-LaLiga.svg.png", x = .42, y = .2, scale = .25) + 
  draw_plot(la_liga_goals_density)

la_liga_goals_logo
```

```{r laligaplot3, echo = FALSE}
la_liga_tablepos_density <- la_liga_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = Rk, fill = Revision)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Table Position", y = "Density", title = "Density Plot of La Liga Table Position by Revision Status", subtitle = "Players on winning teams (lower table position) make up a substantial proportion of the La Liga TOTS dataset") + 
theme(plot.subtitle = element_text(hjust = .4, size = 10), plot.title = element_text(hjust = .1, size = 13.5))

la_liga_tablepos_logo <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/commons/thumb/1/13/LaLiga.svg/1200px-LaLiga.svg.png", x = .42, y = .2, scale = .25) + 
  draw_plot(la_liga_tablepos_density)

la_liga_tablepos_logo
```

```{r lalligaplot4, echo = FALSE}
la_liga_mppn_density <- la_liga_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = minutes_played_divided_by90, fill = Revision)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Total Minutes Played Dived by 90 (Full Games Played)", y = "Density", title = "Density Plot of La Liga Minutes Played (Per 90 Minutes) by Revision Status", subtitle = "Players who accrue more minutes per contest were more likely to be selected for La Liga TOTS") + 
theme(plot.subtitle = element_text(hjust = .3, size = 10), plot.title = element_text(hjust = .4, size = 13))

la_liga_mppn_logo <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/commons/thumb/1/13/LaLiga.svg/1200px-LaLiga.svg.png", x = .42, y = .22, scale = .25) + 
  draw_plot(la_liga_mppn_density)

la_liga_mppn_logo
```

```{r laligaplot5, echo = FALSE}
la_liga_positions <- la_liga_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = position, fill = Revision)) +
  geom_bar(position = "identity") +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Position", y = "Count", title = "Positional Breakdown Within La Liga Dataset") + theme(plot.title = element_text(hjust = .5))

la_liga_positions_logo <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/commons/thumb/1/13/LaLiga.svg/1200px-LaLiga.svg.png", x = .425, y = .23, scale = .25) + 
  draw_plot(la_liga_positions)

la_liga_positions_logo
```


```{r laligamod3, echo = FALSE}
la_liga_modeling_outfield <- la_liga_modeling %>% 
  filter(position != "GK") %>% 
  filter(minutes_played_divided_by90 >= 19) %>% 
  mutate(position = ifelse(position == "RWB", "RB", ifelse(position == "LWB", "LB", ifelse(position == "CF", "ST", position)))) %>% 
  select(-Goals_allowed, -GA90, -SoTA, -Saves, -Save_percent, -W, -L, -D, -CS, -CS_percent, -Pkatt_against, -PKA, -PKsv, -Pk_Save_percent, -PKm)
```


```{r laligamod4, echo = FALSE}
set.seed(494)
la_liga_split <- initial_split(la_liga_modeling_outfield, prop = .75, strata = "revision")
la_liga_training <- training(la_liga_split)
la_liga_testing <- testing(la_liga_split)
```

```{r message = FALSE, warning = FALSE, echo = FALSE}
la_liga_train_metrics <- la_liga_training %>% 
  mutate(Type = "Training") %>% 
  rename(Revision = revision) %>% 
  group_by(Revision, Type) %>% 
  summarize(Goals = mean(Gls, na.rm = T), Assists = mean(Ast, na.rm = T), `Non PK Goals` = mean(Non_PK_G, na.rm = T), PK = mean(PK, na.rm = T), `Team Rank` = mean(Rk, na.rm = T), `Minutes Per 90` = mean(Min, na.rm = T)/90 , `Goals SD` = sd(Gls, na.rm = T), `Assists SD` = sd(Ast, na.rm = T), `Non PK Goals SD` = sd(Non_PK_G, na.rm = T),`Team Rank SD` = sd(Rk, na.rm = T), `Minutes Per 90 SD` = sd(Min, na.rm = T)/90)

la_liga_test_metrics <- la_liga_testing %>% 
  mutate(Type = "Testing") %>% 
  rename(Revision = revision) %>% 
  group_by(Revision, Type) %>% 
  summarize(Goals = mean(Gls, na.rm = T), Assists = mean(Ast, na.rm = T), `Non PK Goals` = mean(Non_PK_G, na.rm = T), PK = mean(PK, na.rm = T),`Team Rank` = mean(Rk, na.rm = T), `Minutes Per 90` = mean(Min, na.rm = T)/90, `Goals SD` = sd(Gls, na.rm = T), `Assists SD` = sd(Ast, na.rm = T), `Non PK Goals SD` = sd(Non_PK_G, na.rm = T),`Team Rank SD` = sd(Rk, na.rm = T), `Minutes Per 90 SD` = sd(Min, na.rm = T)/90)

la_liga_rebound_split <- rbind(la_liga_train_metrics, la_liga_test_metrics) %>% arrange(Revision)

la_liga_metrics_table <- formattable(la_liga_rebound_split[1:4,1:13])

kable(la_liga_metrics_table, align = c(rep('c', 1))) %>% 
  row_spec(0) %>% 
  kable_styling(full_width = F) %>% 
  add_header_above(c("La Liga Training and Testing Group Comparison for Suspected KPIs" = 13), background = "navy", color = "red")
```


```{r laligaranger1, echo = FALSE}
la_liga_ranger_recipe <- recipe(revision ~., data = la_liga_training) %>% 
  step_rm(Player, Nation, Squad, Born, G_per90, A_per90, minutes_played_divided_by90, OG, Attendance) %>% 
  step_upsample(revision, over_ratio = .5) %>% 
  step_mutate_at(all_numeric(), fn = ~as.numeric(.))

la_liga_ranger_recipe %>% 
  prep(la_liga_training) %>% 
  juice()
```


```{r laligaranger2, echo = FALSE}
la_liga_ranger <- rand_forest(mtry = tune(), 
              min_n = tune(), 
              trees = 100) %>% 
  set_mode("classification") %>% 
  set_engine("ranger")

la_liga_ranger_wf <- 
  workflow() %>% 
  add_recipe(la_liga_ranger_recipe) %>% 
  add_model(la_liga_ranger) 

la_liga_ranger_wf
```


```{r laligaranger3, echo = FALSE}
set.seed(494)
la_liga_cv <- vfold_cv(la_liga_training, v = 5)

la_liga_rf_grid <- grid_regular(min_n(), finalize(mtry(), la_liga_training %>% select(-revision)), levels = 3)

ctrl_res <- control_stack_grid()

la_liga_ranger_cv <- la_liga_ranger_wf %>% 
  tune_grid(resamples = la_liga_cv,
           grid = la_liga_rf_grid,
           control = ctrl_res)

collect_metrics(la_liga_ranger_cv)
```


```{r laligaranger4, echo = FALSE}
la_liga_best1 <- la_liga_ranger_cv %>% 
  select_best(metric = "accuracy")

la_liga_ranger_final_wf<- la_liga_ranger_wf %>% 
  finalize_workflow(la_liga_best1)
```

```{r laligaranger5, echo = FALSE}
set.seed(494)
la_liga_ranger_fit <- la_liga_ranger_final_wf %>% 
  fit(la_liga_training)


la_liga_rf_explain <- 
  explain_tidymodels(
    model = la_liga_ranger_fit,
    data = la_liga_training %>% select(-revision), 
    y = as.numeric(la_liga_training$revision == "TOTS"),
    label = "rf"
  )
```

```{r laligavip1, echo = FALSE}
la_liga_rf_var_imp <- 
  model_parts(
    la_liga_rf_explain
    )

plot(la_liga_rf_var_imp)
```

```{r laligaranger6, echo = FALSE}
la_liga_ranger_test <- la_liga_ranger_final_wf %>% 
  last_fit(la_liga_split)

la_liga_ranger_test %>% 
  collect_metrics()
```

```{r laligaconfuse1, echo = FALSE}
preds1 <- la_liga_ranger_test %>% 
  collect_predictions()

preds1 %>% 
  conf_mat(revision, .pred_class)
```

```{r laligaranger7, echo = FALSE}
la_liga_ranger_test <- la_liga_testing %>% 
  bind_cols(predict(la_liga_ranger_fit, new_data = la_liga_testing, type = "prob")) %>% 
  bind_cols(predict(la_liga_ranger_fit, new_data = la_liga_testing)) 
```

```{r laligaconfuse2, echo = FALSE}
la_liga_ranger_test %>% 
  conf_mat(revision, .pred_class)
```

```{r message = FALSE, echo = FALSE}
la_liga_ranger_test <- la_liga_testing %>% 
  bind_cols(predict(la_liga_ranger_fit, new_data = la_liga_testing, type = "prob")) %>% 
  bind_cols(predict(la_liga_ranger_fit, new_data = la_liga_testing)) 

la_liga_rf_preds <- la_liga_ranger_test %>% 
  conf_mat(revision, .pred_class)

la_liga_rf_ggconfusion <- autoplot(la_liga_rf_preds, type = "heatmap") + labs(title = "Confusion Matrix of La Liga Random Forest Model") + scale_fill_gradient(low = "blue", high = "red") + theme(plot.title = element_text(hjust = .5, size = 15))

la_liga_rf_final_confusion <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/commons/thumb/1/13/LaLiga.svg/1200px-LaLiga.svg.png", x = -.43, y = .4, scale = .18) + 
  draw_plot(la_liga_rf_ggconfusion)

la_liga_rf_final_confusion 
```

```{r laligawrong1, echo = FALSE}
la_liga_ranger_test %>% 
  filter(revision != .pred_class)
```



```{r 21laligamod1, echo = FALSE}
la_liga_modeling21 <- fifa21_modeling_la_liga %>% 
  mutate(revision = as.factor(revision), Nation = as.factor(Nation), Age = as.integer(Age))
```

```{r 21laligaoutfield, echo = FALSE}
la_liga_modeling_outfield21 <- la_liga_modeling21 %>% 
  filter(position != "GK") %>% 
  filter(minutes_played_divided_by90 >= 14) %>% 
  mutate(position = ifelse(position == "RWB", "RB", ifelse(position == "LWB", "LB", ifelse(position == "CF", "ST", position))))
```


```{r 21laligaranger1, echo = FALSE}
la_liga_ranger_test21 <- la_liga_modeling_outfield21 %>% 
  bind_cols(predict(la_liga_ranger_fit, new_data = la_liga_modeling_outfield21, type = "prob")) %>% 
  bind_cols(predict(la_liga_ranger_fit, new_data = la_liga_modeling_outfield21)) 
```


```{r 21laligapredictATT, echo = FALSE}
la_liga_ranger_test21 %>% 
  filter(position %in% c("ST", "RW", "CF", "LW")) %>% 
  arrange(desc(.pred_TOTS)) %>% 
  head(5)
```

```{r 21laligapredictMID, echo = FALSE}
la_liga_ranger_test21 %>% 
  filter(position %in% c("CAM", "CM", "CDM", "LM", "RM")) %>% 
  arrange(desc(.pred_TOTS)) %>% 
  head(5)
```


```{r 21laligapredictDEF, echo = FALSE}
la_liga_ranger_test21 %>% 
  filter(position %in% c("LB", "CB", "RB")) %>% 
  arrange(desc(.pred_TOTS)) %>% 
  head(5)
```


![La Liga Team of the Season](LaLigaTOTS.jpg)







\
\









## French Ligue 1


```{r ligue1mod, echo = FALSE}
ligue1_fifa19_modeling <- ligue1_fifa19_modeling %>%
  mutate(Player = paste(Player, '19'))

ligue1_fifa18_modeling <- ligue1_fifa18_modeling %>%
  mutate(Player = paste(Player, '18'))

ligue1_fifa17_modeling <- ligue1_fifa17_modeling %>%
  mutate(Player = paste(Player, '17'))

ligue1_modeling <- ligue1_fifa17_modeling %>% 
  bind_rows(ligue1_fifa18_modeling, ligue1_fifa19_modeling) %>% 
  mutate(revision = as.factor(revision), Nation = as.factor(Nation))
```


```{r ligue1plot1, echo = FALSE}
theme_set(theme_cowplot())

ligue1_prop <- ligue1_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = Revision, fill = Revision)) +
  geom_bar() +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Revision", y = "Count", title = "Proportion of Revisions Within Ligue 1 Dataset Selected for TOTS") +
  theme(plot.title = element_text(hjust = .2, size = 13.5)) +
  geom_vline(xintercept = 0, linetype = "dotted") 
ligue1_prop_logo <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Ligue1.svg/1200px-Ligue1.svg.png", x = .42, y = .23, scale = .25) + 
  draw_plot(ligue1_prop)

ligue1_prop_logo
```



```{r ligue1plot2, echo = FALSE}
ligue1_goals_density <- ligue1_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = Gls, fill = Revision)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Goals", y = "Density", title = "Density Plot of Goals Scored in Ligue 1 Season by Revision Status", subtitle = "TOTS players tend to score goals more prolifically than their non-selected counterparts") + 
theme(plot.subtitle = element_text(hjust = -.35, size = 11), plot.title = element_text(hjust = .1, size = 13.5))

ligue1_goals_logo <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Ligue1.svg/1200px-Ligue1.svg.png", x = .42, y = .2, scale = .25) + 
  draw_plot(ligue1_goals_density)

ligue1_goals_logo
```

```{r ligue1plot3, echo = FALSE}
ligue1_tablepos_density <- ligue1_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = Rk, fill = Revision)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Table Position", y = "Density", title = "Density Plot of Ligue 1 Table Position by Revision Status", subtitle = "Players on winning teams (lower table position) make up a substantial proportion of the Ligue 1 TOTS dataset") + 
theme(plot.subtitle = element_text(hjust = .4, size = 10), plot.title = element_text(hjust = .1, size = 13.5))

ligue1_tablepos_logo <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Ligue1.svg/1200px-Ligue1.svg.png", x = .42, y = .2, scale = .25) + 
  draw_plot(ligue1_tablepos_density)

ligue1_tablepos_logo
```

```{r ligue1plot4, echo = FALSE}
ligue1_mppn_density <- ligue1_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = minutes_played_divided_by90, fill = Revision)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Total Minutes Played Dived by 90 (Full Games Played)", y = "Density", title = "Density Plot of Minutes Played (Per 90 Minutes) by Revision Status", subtitle = "Players who accrue more minutes per contest are more likely to be selected for Ligue 1 TOTS") + 
theme(plot.subtitle = element_text(hjust = .3, size = 10), plot.title = element_text(hjust = .8, size = 13))

ligue1_mppn_logo <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Ligue1.svg/1200px-Ligue1.svg.png", x = .42, y = .2, scale = .25) + 
  draw_plot(ligue1_mppn_density)

ligue1_mppn_logo
```

```{r ligue1plot5, echo = FALSE}
ligue1_positions <- ligue1_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = position, fill = Revision)) +
  geom_bar(position = "identity") +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Position", y = "Count", title = "Positional Breakdown Within Ligue 1 Dataset") + theme(plot.title = element_text(hjust = .5))

ligue1_positions_logo <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Ligue1.svg/1200px-Ligue1.svg.png", x = .42, y = .22, scale = .25) + 
  draw_plot(ligue1_positions)

ligue1_positions_logo
```


```{r ligue1mod2, echo = FALSE}
ligue1_modeling_outfield <- ligue1_modeling %>% 
  filter(position != "GK") %>% 
  filter(minutes_played_divided_by90 >= 19) %>% 
  mutate(position = ifelse(position == "RWB", "RB", ifelse(position == "LWB", "LB", position))) %>% 
  select(-Goals_allowed, -GA90, -SoTA, -Saves, -Save_percent, -W, -L, -D, -CS, -CS_percent, -Pkatt_against, -PKA, -PKsv, -Pk_Save_percent, -PKm)
```


```{r ligue1mod3, echo = FALSE}
set.seed(494)
ligue1_split <- initial_split(ligue1_modeling_outfield, prop = .75, strata = "revision")
ligue1_training <- training(ligue1_split)
ligue1_testing <- testing(ligue1_split)
```

```{r}
ligue1_train_metrics <- ligue1_training %>% 
  mutate(Type = "Training") %>% 
  rename(Revision = revision) %>% 
  group_by(Revision, Type) %>% 
  summarize(Goals = mean(Gls, na.rm = T), Assists = mean(Ast, na.rm = T), `Non PK Goals` = mean(Non_PK_G, na.rm = T), PK = mean(PK, na.rm = T), `Team Rank` = mean(Rk, na.rm = T), `Minutes Per 90` = mean(Min, na.rm = T)/90 , `Goals SD` = sd(Gls, na.rm = T), `Assists SD` = sd(Ast, na.rm = T), `Non PK Goals SD` = sd(Non_PK_G, na.rm = T),`Team Rank SD` = sd(Rk, na.rm = T), `Minutes Per 90 SD` = sd(Min, na.rm = T)/90)

ligue1_test_metrics <- ligue1_testing %>% 
  mutate(Type = "Testing") %>% 
  rename(Revision = revision) %>% 
  group_by(Revision, Type) %>% 
  summarize(Goals = mean(Gls, na.rm = T), Assists = mean(Ast, na.rm = T), `Non PK Goals` = mean(Non_PK_G, na.rm = T), PK = mean(PK, na.rm = T),`Team Rank` = mean(Rk, na.rm = T), `Minutes Per 90` = mean(Min, na.rm = T)/90, `Goals SD` = sd(Gls, na.rm = T), `Assists SD` = sd(Ast, na.rm = T), `Non PK Goals SD` = sd(Non_PK_G, na.rm = T),`Team Rank SD` = sd(Rk, na.rm = T), `Minutes Per 90 SD` = sd(Min, na.rm = T)/90)

ligue1_rebound_split <- rbind(ligue1_train_metrics, ligue1_test_metrics) %>% arrange(Revision)

ligue1_metrics_table <- formattable(ligue1_rebound_split[1:4,1:13])

kable(ligue1_metrics_table, align = c(rep('c', 1))) %>% 
  row_spec(0) %>% 
  kable_styling(full_width = F) %>% 
  add_header_above(c("Ligue 1 Training and Testing Group Comparison for Suspected KPIs" = 13), background = "navy", color = "white")
```

```{r ligue1ranger1, echo = FALSE}
ligue1_ranger_recipe <- recipe(revision ~., data = ligue1_training) %>% 
  step_rm(Player, Nation, Squad, Born, minutes_played_divided_by90, G_per90, A_per90, Attendance) %>% 
  step_upsample(revision, over_ratio = .4) %>% 
  step_mutate_at(all_numeric(), fn = ~as.numeric(.))

ligue1_ranger_recipe %>% 
  prep(ligue1_training) %>% 
  juice()
```


```{r ligue1ranger2, echo = FALSE}
ligue1_ranger <- rand_forest(mtry = tune(), 
              min_n = tune(), 
              trees = 100) %>% 
  set_mode("classification") %>% 
  set_engine("ranger")

ligue1_ranger_wf <- 
  workflow() %>% 
  add_recipe(ligue1_ranger_recipe) %>% 
  add_model(ligue1_ranger) 

ligue1_ranger_wf
```


```{r ligue1ranger3, echo = FALSE}
set.seed(494)
ligue1_cv <- vfold_cv(ligue1_training, v = 5)

ligue1_rf_grid <- grid_regular(min_n(), finalize(mtry(), ligue1_training %>% select(-revision)), levels = 3)

ligue1_ctrl_res <- control_stack_grid()

ligue1_ranger_cv <- ligue1_ranger_wf %>% 
  tune_grid(resamples = ligue1_cv,
           grid = ligue1_rf_grid,
           control = ligue1_ctrl_res)

collect_metrics(ligue1_ranger_cv)
```


```{r ligue1ranger4, echo = FALSE}
ligue1_best1 <- ligue1_ranger_cv %>% 
  select_best(metric = "accuracy")

ligue1_ranger_final_wf<- ligue1_ranger_wf %>% 
  finalize_workflow(ligue1_best1)
```

```{r ligue1ranger5, echo = FALSE}
ligue1_ranger_fit <- ligue1_ranger_final_wf %>% 
  fit(ligue1_training)


ligue1_rf_explain <- 
  explain_tidymodels(
    model = ligue1_ranger_fit,
    data = ligue1_training %>% select(-revision), 
    y = as.numeric(ligue1_training$revision == "TOTS"),
    label = "rf"
  )
```

```{r ligue1vip, echo = FALSE}
ligue1_rf_var_imp <- 
  model_parts(
    ligue1_rf_explain
    )

plot(ligue1_rf_var_imp)
```


```{r ligue1ranger6, echo = FALSE}
ligue1_ranger_test <- ligue1_ranger_final_wf %>% 
  last_fit(ligue1_split)

ligue1_ranger_test %>% 
  collect_metrics()
```

```{r ligue1confuse1, echo = FALSE}
ligue1_preds1 <- ligue1_ranger_test %>% 
  collect_predictions()
```


```{r ligue1ranger7, message = FALSE, echo = FALSE} 
ligue1_ranger_test <- ligue1_testing %>% 
  bind_cols(predict(ligue1_ranger_fit, new_data = ligue1_testing, type = "prob")) %>% 
  bind_cols(predict(ligue1_ranger_fit, new_data = ligue1_testing)) 

ligue1_confusion_table <- ligue1_ranger_test %>% 
  conf_mat(revision, .pred_class)

ligue1_rf_ggconfusion <- autoplot(ligue1_confusion_table, type = "heatmap") + labs(title = "Confusion Matrix of Ligue 1 Random Forest Model") + scale_fill_gradient(low = "blue", high = "red") + theme(plot.title = element_text(hjust = .5, size = 15))


ligue1_rf_final_confusion <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Ligue1.svg/1200px-Ligue1.svg.png", x = -.43, y = .4, scale = .18) + 
  draw_plot(ligue1_rf_ggconfusion)

ligue1_rf_final_confusion 
```

```{r ligue1confuse2, echo = FALSE}
ligue1_ranger_test %>% 
  conf_mat(revision, .pred_class)
```

```{r ligue1wrong, echo = FALSE}
ligue1_ranger_test %>% 
  filter(revision != .pred_class)
```

```{r 21ligue1mod1, echo = FALSE}
ligue1_modeling21 <- fifa21_modeling_ligue1 %>% 
  mutate(revision = as.factor(revision), Nation = as.factor(Nation), Age = as.integer(Age))
```

```{r 21ligue1outfield, echo = FALSE}
ligue1_modeling_outfield21 <- ligue1_modeling21 %>% 
  filter(position != "GK") %>% 
  filter(minutes_played_divided_by90 >= 14) %>% 
  mutate(position = ifelse(position == "RWB", "RB", ifelse(position == "LWB", "LB", position)))
```


```{r 21ligue1ranger, echo = FALSE}
ligue1_ranger_test21 <- ligue1_modeling_outfield21 %>% 
  bind_cols(predict(ligue1_ranger_fit, new_data = ligue1_modeling_outfield21, type = "prob")) %>% 
  bind_cols(predict(ligue1_ranger_fit, new_data = ligue1_modeling_outfield21)) 
```


```{r 21ligue1predictATT, echo = FALSE}
ligue1_ranger_test21 %>% 
  filter(position %in% c("ST", "RW", "CF", "LW")) %>% 
  arrange(desc(.pred_TOTS)) %>% 
  head(5)
```

```{r 21ligue1predictMID, echo = FALSE}
ligue1_ranger_test21 %>% 
  filter(position %in% c("CAM", "CM", "CDM", "LM", "RM")) %>% 
  arrange(desc(.pred_TOTS)) %>% 
  head(5)
```

```{r 21ligue1predictDEF, echo = FALSE}
ligue1_ranger_test21 %>% 
  filter(position %in% c("LB", "CB", "RB")) %>% 
  arrange(desc(.pred_TOTS)) %>% 
  head(5)
```


![Ligue 1 Team of the Season](Ligue1TOTS.jpg)







\
\







## German Bundesliga

```{r bundesligamod1, echo = FALSE}
fifa19_modeling_bundesliga2 <- fifa19_modeling_bundesliga %>%
  mutate(Player = paste(Player, '19'))

fifa18_modeling_bundesliga2 <- fifa18_modeling_bundesliga %>%
  mutate(Player = paste(Player, '18'))

fifa17_modeling_bundesliga2 <- fifa17_modeling_bundesliga %>%
  mutate(Player = paste(Player, '17'))



bundesliga_modeling <- fifa17_modeling_bundesliga2%>% 
  bind_rows(fifa18_modeling_bundesliga2, fifa19_modeling_bundesliga2) %>% 
  mutate(revision = as.factor(revision), Nation = as.factor(Nation))
```

```{r bundesligaplot1, echo = FALSE}
bundesliga_modeling %>% 
  select(where(is.numeric)) %>% 
  pivot_longer(cols = everything(),
               names_to = "variable", 
               values_to = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30) +
  facet_wrap(vars(variable), 
             scales = "free")
```

```{r bundesligaplot2, echo = FALSE}
theme_set(theme_cowplot())

bundesliga_prop <- bundesliga_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = Revision, fill = Revision)) +
  geom_bar() +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Revision", y = "Count", title = "Proportion of Revisions Within Bundesliga Dataset Selected for TOTS") +
  theme(plot.title = element_text(hjust = .2, size = 13.5)) +
  geom_vline(xintercept = 0, linetype = "dotted") 
bundesliga_prop_logo <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/en/thumb/d/df/Bundesliga_logo_%282017%29.svg/1200px-Bundesliga_logo_%282017%29.svg.png", x = .425, y = .23, scale = .25) + 
  draw_plot(bundesliga_prop)

bundesliga_prop_logo
```


```{r bundesligaplot3, echo = FALSE}
bundesliga_goals_density <- bundesliga_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = Gls, fill = Revision)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Goals", y = "Density", title = "Density Plot of Goals Scored in Bundesliga Season by Revision Status", subtitle = "TOTS players tend to score goals more prolifically than their non-selected counterparts") + 
theme(plot.subtitle = element_text(hjust = -.35, size = 11), plot.title = element_text(hjust = .1, size = 13.5))

bundesliga_goals_logo <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/en/thumb/d/df/Bundesliga_logo_%282017%29.svg/1200px-Bundesliga_logo_%282017%29.svg.png", x = .42, y = .2, scale = .25) + 
  draw_plot(bundesliga_goals_density)

bundesliga_goals_logo
```

```{r bundesligaplot4, echo = FALSE}
bundesliga_tablepos_density <- bundesliga_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = Rk, fill = Revision)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Table Position", y = "Density", title = "Density Plot of Bundesliga Table Position by Revision Status", subtitle = "Players on winning teams (lower table position) make up a substantial proportion of the Bundesliga TOTS dataset") + 
theme(plot.subtitle = element_text(hjust = .4, size = 10), plot.title = element_text(hjust = .1, size = 13.5))

bundesliga_tablepos_logo <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/en/thumb/d/df/Bundesliga_logo_%282017%29.svg/1200px-Bundesliga_logo_%282017%29.svg.png", x = .42, y = .2, scale = .25) + 
  draw_plot(bundesliga_tablepos_density)

bundesliga_tablepos_logo
```

```{r bundesligaplot5, echo = FALSE}
bundesliga_mppn_density <- bundesliga_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = minutes_played_divided_by90, fill = Revision)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Total Minutes Played Dived by 90 (Full Games Played)", y = "Density", title = "Density Plot of Minutes Played (Per 90 Minutes) by Revision Status", subtitle = "Players who accrue more minutes per contest are more likely to be selected for Bundesliga TOTS") + 
theme(plot.subtitle = element_text(hjust = .3, size = 10), plot.title = element_text(hjust = .8, size = 13))

bundesliga_mppn_logo <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/en/thumb/d/df/Bundesliga_logo_%282017%29.svg/1200px-Bundesliga_logo_%282017%29.svg.png", x = .42, y = .2, scale = .25) + 
  draw_plot(bundesliga_mppn_density)

bundesliga_mppn_logo
```

```{r bundesligaplot6, echo = FALSE}
bundesliga_positions <- bundesliga_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = position, fill = Revision)) +
  geom_bar(position = "identity") +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Position", y = "Count", title = "Positional Breakdown Within Bundesliga Dataset") + theme(plot.title = element_text(hjust = .5))

bundesliga_positions_logo <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/en/thumb/d/df/Bundesliga_logo_%282017%29.svg/1200px-Bundesliga_logo_%282017%29.svg.png", x = .42, y = .22, scale = .25) + 
  draw_plot(bundesliga_positions)

bundesliga_positions_logo
```


```{r bundesligamod2, echo = FALSE}
bundesliga_modeling_outfield <- bundesliga_modeling %>% 
  filter(position != "GK") %>% 
  filter(minutes_played_divided_by90 >= 19) %>% 
  mutate(position = ifelse(position == "RWB", "RB", ifelse(position == "LWB", "LB", ifelse(position == "RW", "RM", ifelse(position == "LW", "LM", position))))) %>% 
  select(-Goals_allowed, -GA90, -SoTA, -Saves, -Save_percent, -W, -L, -D, -CS, -CS_percent, -Pkatt_against, -PKA, -PKsv, -Pk_Save_percent, -PKm)
```


```{r bundesligamod3, echo = FALSE}
set.seed(494)
bundesliga_split <- initial_split(bundesliga_modeling_outfield, prop = .75, strata = "revision")
bundesliga_training <- training(bundesliga_split)
bundesliga_testing <- testing(bundesliga_split)
```

```{r bundesligatable1, echo = FALSE}
bundesliga_train_metrics <- bundesliga_training %>% 
  mutate(Type = "Training") %>% 
  rename(Revision = revision) %>% 
  group_by(Revision, Type) %>% 
  summarize(Goals = mean(Gls, na.rm = T), Assists = mean(Ast, na.rm = T), `Non PK Goals` = mean(Non_PK_G, na.rm = T), PK = mean(PK, na.rm = T), `Team Rank` = mean(Rk, na.rm = T), `Minutes Per 90` = mean(Min, na.rm = T)/90 , `Goals SD` = sd(Gls, na.rm = T), `Assists SD` = sd(Ast, na.rm = T), `Non PK Goals SD` = sd(Non_PK_G, na.rm = T),`Team Rank SD` = sd(Rk, na.rm = T), `Minutes Per 90 SD` = sd(Min, na.rm = T)/90)

bundesliga_test_metrics <- bundesliga_testing %>% 
  mutate(Type = "Testing") %>% 
  rename(Revision = revision) %>% 
  group_by(Revision, Type) %>% 
  summarize(Goals = mean(Gls, na.rm = T), Assists = mean(Ast, na.rm = T), `Non PK Goals` = mean(Non_PK_G, na.rm = T), PK = mean(PK, na.rm = T),`Team Rank` = mean(Rk, na.rm = T), `Minutes Per 90` = mean(Min, na.rm = T)/90, `Goals SD` = sd(Gls, na.rm = T), `Assists SD` = sd(Ast, na.rm = T), `Non PK Goals SD` = sd(Non_PK_G, na.rm = T),`Team Rank SD` = sd(Rk, na.rm = T), `Minutes Per 90 SD` = sd(Min, na.rm = T)/90)

bundesliga_rebound_split <- rbind(bundesliga_train_metrics, bundesliga_test_metrics) %>% arrange(Revision)

bundesliga_metrics_table <- formattable(bundesliga_rebound_split[1:4,1:13])

kable(bundesliga_metrics_table, align = c(rep('c', 1))) %>% 
  row_spec(0) %>% 
  kable_styling(full_width = F) %>% 
  add_header_above(c("Bundesliga Training and Testing Group Comparison for Suspected KPIs" = 13), background = "red", color = "white")
```

```{r bundesliaranger1, echo = FALSE}
bundesliga_ranger_recipe <- recipe(revision ~., data = bundesliga_training) %>% 
  step_rm(Player, Nation, Squad, G_per90, A_per90, minutes_played_divided_by90, Attendance, Born) %>% 
  step_upsample(revision, over_ratio = .55) %>% 
  step_mutate_at(all_numeric(), fn = ~as.numeric(.))

bundesliga_ranger_recipe %>% 
  prep(bundesliga_training) %>% 
  juice()
```


```{r bundesligaranger2, echo = FALSE}
bundesliga_ranger <- rand_forest(mtry = tune(), 
              min_n = tune(), 
              trees = 100) %>% 
  set_mode("classification") %>% 
  set_engine("ranger")

bundesliga_ranger_wf <- 
  workflow() %>% 
  add_recipe(bundesliga_ranger_recipe) %>% 
  add_model(bundesliga_ranger) 

bundesliga_ranger_wf
```


```{r bundesligaranger3, echo = FALSE}
set.seed(494)
bundesliga_cv <- vfold_cv(bundesliga_training, v = 5)

bundesliga_rf_grid <- grid_regular(min_n(), finalize(mtry(), bundesliga_training %>% select(-revision)), levels = 3)

ctrl_res <- control_stack_grid()

bundesliga_ranger_cv <- bundesliga_ranger_wf %>% 
  tune_grid(resamples = bundesliga_cv,
           grid = bundesliga_rf_grid,
           control = ctrl_res)

collect_metrics(bundesliga_ranger_cv)
```


```{r bundesligaranger4, echo = FALSE}
bundesliga_best1 <- bundesliga_ranger_cv %>% 
  select_best(metric = "accuracy")

bundesliga_ranger_final_wf<- bundesliga_ranger_wf %>% 
  finalize_workflow(bundesliga_best1)
```

```{r bundesligaranger5, echo = FALSE}
set.seed(494)
bundesliga_ranger_fit <- bundesliga_ranger_final_wf %>% 
  fit(bundesliga_training)


bundesliga_rf_explain <- 
  explain_tidymodels(
    model = bundesliga_ranger_fit,
    data = bundesliga_training %>% select(-revision), 
    y = as.numeric(bundesliga_training$revision == "TOTS"),
    label = "rf"
  )
```

```{r bundesligavip, echo = FALSE}
bundesliga_rf_var_imp <- 
  model_parts(
    bundesliga_rf_explain
    )

plot(bundesliga_rf_var_imp)
```





```{r bundesligaranger6, echo = FALSE}
bundesliga_ranger_test <- bundesliga_ranger_final_wf %>% 
  last_fit(bundesliga_split)

bundesliga_ranger_test %>% 
  collect_metrics()
```

```{r bundesligaconfuse1, echo = FALSE}
preds1 <- bundesliga_ranger_test %>% 
  collect_predictions()

preds1 %>% 
  conf_mat(revision, .pred_class)
```

```{r bundesligaranger7,message = FALSE, echo = FALSE}
bundesliga_ranger_test <- bundesliga_testing %>% 
  bind_cols(predict(bundesliga_ranger_fit, new_data = bundesliga_testing, type = "prob")) %>% 
  bind_cols(predict(bundesliga_ranger_fit, new_data = bundesliga_testing)) 

bundesliga_ranger_test %>% 
  conf_mat(revision, .pred_class)

bundesliga_confusion_table <- bundesliga_ranger_test %>% 
  conf_mat(revision, .pred_class)
```

```{r message = FALSE, echo = FALSE}
bundesliga_rf_ggconfusion <- autoplot(bundesliga_confusion_table, type = "heatmap") + labs(title = "Confusion Matrix of Bundesliga Random Forest Model") + scale_fill_gradient(low = "blue", high = "red") + theme(plot.title = element_text(hjust = .5, size = 15))


bundesliga_rf_final_confusion <- ggdraw() + draw_image("https://upload.wikimedia.org/wikipedia/en/thumb/d/df/Bundesliga_logo_%282017%29.svg/1200px-Bundesliga_logo_%282017%29.svg.png", x = -.43, y = .4, scale = .18) + 
  draw_plot(bundesliga_rf_ggconfusion)

bundesliga_rf_final_confusion 
```

```{r bundesligaconfuse2, echo = FALSE}
bundesliga_ranger_test %>% 
  conf_mat(revision, .pred_class)
```

```{r bundesligawrong, echo = FALSE}
bundesliga_ranger_test %>% 
  filter(revision != .pred_class)
```

```{r 21bundesligamod, echo = FALSE}
bundesliga_modeling21 <- fifa21_modeling_bundesliga %>% 
  mutate(revision = as.factor(revision), Nation = as.factor(Nation), Age = as.integer(Age))
```

```{r 21bundesligaoutfield, echo = FALSE}
bundesliga_modeling_outfield21 <- bundesliga_modeling21 %>% 
  filter(position != "GK") %>% 
  filter(minutes_played_divided_by90 >= 18) %>% 
  mutate(position = ifelse(position == "RWB", "RB", ifelse(position == "LWB", "LB", ifelse(position == "RW", "RM", ifelse(position == "LW", "LM", position)))))
```


```{r 21bundesligaranger, echo = FALSE}
bundesliga_ranger_test21 <- bundesliga_modeling_outfield21 %>% 
  bind_cols(predict(bundesliga_ranger_fit, new_data = bundesliga_modeling_outfield21, type = "prob")) %>% 
  bind_cols(predict(bundesliga_ranger_fit, new_data = bundesliga_modeling_outfield21)) 
```

```{r bundesligapredictATT, echo = FALSE}
bundesliga_ranger_test21 %>% 
  filter(position %in% c("ST", "RW", "CF", "LW")) %>% 
  arrange(desc(.pred_TOTS)) %>% 
  head(5)
```

```{r bundesligapredictMID, echo = FALSE}
bundesliga_ranger_test21 %>% 
  filter(position %in% c("CAM", "CM", "CDM", "LM", "RM")) %>% 
  arrange(desc(.pred_TOTS)) %>% 
  head(5)
```

```{r bundesligapredictDEF, echo = FALSE}
bundesliga_ranger_test21 %>% 
  filter(position %in% c("LB", "CB", "RB")) %>% 
  arrange(desc(.pred_TOTS)) %>% 
  head(5)
```




![Bundesliga Team of the Season](BundesligaTOTS.jpg)










\
\











## Italian Serie A


```{r serieamod1, echo = FALSE}
fifa19_modeling_serie_a2 <- fifa19_modeling_serie_a %>%
  mutate(Player = paste(Player, '19'))

fifa18_modeling_serie_a2 <- fifa18_modeling_serie_a %>%
  mutate(Player = paste(Player, '18'))

fifa17_modeling_serie_a2 <- fifa17_modeling_serie_a %>%
  mutate(Player = paste(Player, '17'))



serie_a_modeling <- fifa17_modeling_serie_a2%>% 
  bind_rows(fifa18_modeling_serie_a2, fifa19_modeling_serie_a2) %>% 
  mutate(revision = as.factor(revision), Nation = as.factor(Nation))
```

```{r serieaplot1, echo = FALSE}
serie_a_modeling %>% 
  select(where(is.numeric)) %>% 
  pivot_longer(cols = everything(),
               names_to = "variable", 
               values_to = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30) +
  facet_wrap(vars(variable), 
             scales = "free")
```

```{r serieaplot2, echo = FALSE}
theme_set(theme_cowplot())
serie_a_prop <- serie_a_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = Revision, fill = Revision)) +
  geom_bar() +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Revision", y = "Count", title = "Proportion of Revisions Within Serie A Dataset Selected for TOTS") +
  theme(plot.title = element_text(hjust = .2, size = 13.5)) +
  geom_vline(xintercept = 0, linetype = "dotted") 
serie_a_prop_logo <- ggdraw() + draw_image("https://static.wikia.nocookie.net/logopedia/images/1/12/Serie_A_2019.svg/revision/latest/scale-to-width-down/140?cb=20190710115458", x = .42, y = .23, scale = .25) + 
  draw_plot(serie_a_prop)

serie_a_prop_logo
```



```{r serieaplot3, echo = FALSE}
serie_a_goals_density <- serie_a_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = Gls, fill = Revision)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Goals", y = "Density", title = "Density Plot of Goals Scored in Serie A Season by Revision Status", subtitle = "TOTS players tend to score goals more prolifically than their non-selected counterparts") + 
theme(plot.subtitle = element_text(hjust = -.35, size = 11), plot.title = element_text(hjust = .1, size = 13.5))

serie_a_goals_logo <- ggdraw() + draw_image("https://static.wikia.nocookie.net/logopedia/images/1/12/Serie_A_2019.svg/revision/latest/scale-to-width-down/140?cb=20190710115458", x = .42, y = .2, scale = .25) + 
  draw_plot(serie_a_goals_density)

serie_a_goals_logo
```

```{r serieaplot4, echo = FALSE}
serie_a_tablepos_density <- serie_a_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = Rk, fill = Revision)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Table Position", y = "Density", title = "Density Plot of Serie A Table Position by Revision Status", subtitle = "Players on winning teams (lower table position) make up a substantial proportion of the Serie A TOTS dataset") + 
theme(plot.subtitle = element_text(hjust = .4, size = 10), plot.title = element_text(hjust = .1, size = 13.5))

serie_a_tablepos_logo <- ggdraw() + draw_image("https://static.wikia.nocookie.net/logopedia/images/1/12/Serie_A_2019.svg/revision/latest/scale-to-width-down/140?cb=20190710115458", x = .42, y = .2, scale = .25) + 
  draw_plot(serie_a_tablepos_density)

serie_a_tablepos_logo
```

```{r serieaaplot5, echo = FALSE}
serie_a_mppn_density <- serie_a_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = minutes_played_divided_by90, fill = Revision)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Total Minutes Played Dived by 90 (Full Games Played)", y = "Density", title = "Density Plot of Minutes Played (Per 90 Minutes) by Revision Status", subtitle = "Players who accrue more minutes per contest tend to have a better chance at Serie A TOTS") + 
theme(plot.subtitle = element_text(hjust = .3, size = 10), plot.title = element_text(hjust = .8, size = 13))

serie_a_mppn_logo <- ggdraw() + draw_image("https://static.wikia.nocookie.net/logopedia/images/1/12/Serie_A_2019.svg/revision/latest/scale-to-width-down/140?cb=20190710115458", x = .42, y = .2, scale = .25) + 
  draw_plot(serie_a_mppn_density)

serie_a_mppn_logo
```

```{r serieaplot6, echo = FALSE}
serie_a_positions <- serie_a_modeling %>% 
  rename(Revision = revision) %>% 
  ggplot(aes(x = position, fill = Revision)) +
  geom_bar(position = "identity") +
  scale_fill_manual(values = c("TOTS" = "blue", "Normal" = "gold")) +
  labs(x = "Position", y = "Count", title = "Positional Breakdown Within Serie A Dataset") + theme(plot.title = element_text(hjust = .5))

serie_a_positions_logo <- ggdraw() + draw_image("https://static.wikia.nocookie.net/logopedia/images/1/12/Serie_A_2019.svg/revision/latest/scale-to-width-down/140?cb=20190710115458", x = .42, y = .22, scale = .25) + 
  draw_plot(serie_a_positions)

serie_a_positions_logo
```

```{r serieamod2, echo = FALSE}
serie_a_modeling_outfield <- serie_a_modeling %>% 
  filter(position != "GK") %>% 
  #filter(position %in% c("ST", "LW", "RW", "CF", "CAM")) %>% 
  filter(minutes_played_divided_by90 >= 19) %>% 
  mutate(position = ifelse(position == "RWB", "RB", ifelse(position == "LWB", "LB", ifelse(position == "RW", "RM", ifelse(position == "LW", "LM", position))))) %>% 
  select(-Goals_allowed, -GA90, -SoTA, -Saves, -Save_percent, -W, -L, -D, -CS, -CS_percent, -Pkatt_against, -PKA, -PKsv, -Pk_Save_percent, -PKm)
```


```{r serieamod3, echo = FALSE}
set.seed(494)
serie_a_split <- initial_split(serie_a_modeling_outfield, prop = .75, strata = "revision")
serie_a_training <- training(serie_a_split)
serie_a_testing <- testing(serie_a_split)
```


```{r serieatable1, echo - FALSE}
serie_a_train_metrics <- serie_a_training %>% 
  mutate(Type = "Training") %>% 
  rename(Revision = revision) %>% 
  group_by(Revision, Type) %>% 
  summarize(Goals = mean(Gls, na.rm = T), Assists = mean(Ast, na.rm = T), `Non PK Goals` = mean(Non_PK_G, na.rm = T), PK = mean(PK, na.rm = T), `Team Rank` = mean(Rk, na.rm = T), `Minutes Per 90` = mean(Min, na.rm = T)/90 , `Goals SD` = sd(Gls, na.rm = T), `Assists SD` = sd(Ast, na.rm = T), `Non PK Goals SD` = sd(Non_PK_G, na.rm = T),`Team Rank SD` = sd(Rk, na.rm = T), `Minutes Per 90 SD` = sd(Min, na.rm = T)/90)

serie_a_test_metrics <- serie_a_testing %>% 
  mutate(Type = "Testing") %>% 
  rename(Revision = revision) %>% 
  group_by(Revision, Type) %>% 
  summarize(Goals = mean(Gls, na.rm = T), Assists = mean(Ast, na.rm = T), `Non PK Goals` = mean(Non_PK_G, na.rm = T), PK = mean(PK, na.rm = T),`Team Rank` = mean(Rk, na.rm = T), `Minutes Per 90` = mean(Min, na.rm = T)/90, `Goals SD` = sd(Gls, na.rm = T), `Assists SD` = sd(Ast, na.rm = T), `Non PK Goals SD` = sd(Non_PK_G, na.rm = T),`Team Rank SD` = sd(Rk, na.rm = T), `Minutes Per 90 SD` = sd(Min, na.rm = T)/90)

serie_a_rebound_split <- rbind(serie_a_train_metrics, serie_a_test_metrics) %>% arrange(Revision)

serie_a_metrics_table <- formattable(serie_a_rebound_split[1:4,1:13])

kable(serie_a_metrics_table, align = c(rep('c', 1))) %>% 
  row_spec(0) %>% 
  kable_styling(full_width = F) %>% 
  add_header_above(c("Serie A Training and Testing Group Comparison for Suspected KPIs" = 13), background = "red", color = "#00FF00")
```

```{r seriearanger1, echo = FALSE}
serie_a_ranger_recipe <- recipe(revision ~., data = serie_a_training) %>% 
  step_rm(Player, Nation, Squad, Born, G_per90, A_per90, minutes_played_divided_by90, Attendance) %>% 
  step_upsample(revision, over_ratio = .4) %>% 
  step_mutate_at(all_numeric(), fn = ~as.numeric(.))

serie_a_ranger_recipe %>% 
  prep(serie_a_training) %>% 
  juice()
```


```{r seriearanger2, echo = FALSE}
serie_a_ranger <- rand_forest(mtry = tune(), 
              min_n = tune(), 
              trees = 100) %>% 
  set_mode("classification") %>% 
  set_engine("ranger")

serie_a_ranger_wf <- 
  workflow() %>% 
  add_recipe(serie_a_ranger_recipe) %>% 
  add_model(serie_a_ranger) 

serie_a_ranger_wf
```


```{r seriearanger3, echo = FALSE}
set.seed(494)
serie_a_cv <- vfold_cv(serie_a_training, v = 5)

serie_a_rf_grid <- grid_regular(min_n(), finalize(mtry(), serie_a_training %>% select(-revision)), levels = 3)

ctrl_res <- control_stack_grid()

serie_a_ranger_cv <- serie_a_ranger_wf %>% 
  tune_grid(resamples = serie_a_cv,
           grid = serie_a_rf_grid,
           control = ctrl_res)

collect_metrics(serie_a_ranger_cv)
```


```{r seriearanger4, echo = FALSE}
serie_a_best1 <- serie_a_ranger_cv %>% 
  select_best(metric = "accuracy")

serie_a_ranger_final_wf<- serie_a_ranger_wf %>% 
  finalize_workflow(serie_a_best1)
```

```{r seriearanger5, echo = FALSE}
set.seed(494)
serie_a_ranger_fit <- serie_a_ranger_final_wf %>% 
  fit(serie_a_training)


serie_a_rf_explain <- 
  explain_tidymodels(
    model = serie_a_ranger_fit,
    data = serie_a_training %>% select(-revision), 
    y = as.numeric(serie_a_training$revision == "TOTS"),
    label = "rf"
  )
```

```{r serieavip, echo = FALSE}
serie_a_rf_var_imp <- 
  model_parts(
    serie_a_rf_explain
    )

plot(serie_a_rf_var_imp)
```





```{r seriearanger6, echo = FALSE}
serie_a_ranger_test <- serie_a_ranger_final_wf %>% 
  last_fit(serie_a_split)

serie_a_ranger_test %>% 
  collect_metrics()
```

```{r serieaconfuse1, echo = FALSE}
preds1 <- serie_a_ranger_test %>% 
  collect_predictions()

preds1 %>% 
  conf_mat(revision, .pred_class)
```

```{r seriearanger7, echo = FALSE}
serie_a_ranger_test <- serie_a_testing %>% 
  bind_cols(predict(serie_a_ranger_fit, new_data = serie_a_testing, type = "prob")) %>% 
  bind_cols(predict(serie_a_ranger_fit, new_data = serie_a_testing)) 

serie_a_confusion_table <- serie_a_ranger_test %>% 
  conf_mat(revision, .pred_class)

serie_a_ranger_ggconfusion <- autoplot(serie_a_confusion_table, type = "heatmap") + labs(title = "Confusion Matrix of Serie A Random Forest Model") + scale_fill_gradient(low = "blue", high = "red") + theme(plot.title = element_text(hjust = .5, size = 15))


serie_a_final_confusion <- ggdraw() + draw_image("https://static.wikia.nocookie.net/logopedia/images/1/12/Serie_A_2019.svg/revision/latest/scale-to-width-down/140?cb=20190710115458", x = -.43, y = .4, scale = .18) + 
  draw_plot(serie_a_ranger_ggconfusion)

serie_a_final_confusion 
```

```{r serieaconfuse2, echo = FALSE}
serie_a_ranger_test %>% 
  conf_mat(revision, .pred_class)
```

```{r serieawrong, echo = FALSE}
serie_a_ranger_test %>% 
  filter(revision != .pred_class)
```


```{r 21serieamod1, echo = FALSE}
serie_a_modeling21 <- fifa21_modeling_serie_a %>% 
  mutate(revision = as.factor(revision), Nation = as.factor(Nation), Age = as.integer(Age))
```

```{r 21serieaoutfield, echo = FALSE}
serie_a_modeling_outfield21 <- serie_a_modeling21 %>% 
  filter(position != "GK") %>% 
  filter(minutes_played_divided_by90 >= 14) %>% 
  mutate(position = ifelse(position == "RWB", "RB", ifelse(position == "LWB", "LB", ifelse(position == "RW", "RM", ifelse(position == "LW", "LM", position)))))
```


```{r 21seriearanger, echo = FALSE}
serie_a_ranger_test21 <- serie_a_modeling_outfield21 %>% 
  bind_cols(predict(serie_a_ranger_fit, new_data = serie_a_modeling_outfield21, type = "prob")) %>% 
  bind_cols(predict(serie_a_ranger_fit, new_data = serie_a_modeling_outfield21)) 
```

```{r serieapredictATT, echo = FALSE}
serie_a_ranger_test21 %>% 
  filter(position %in% c("ST", "RW", "CF", "LW")) %>% 
  arrange(desc(.pred_TOTS)) %>% 
  head(5)
```

```{r serieapredictMID, echo = FALSE}
serie_a_ranger_test21 %>% 
  filter(position %in% c("CAM", "CM", "CDM", "LM", "RM")) %>% 
  arrange(desc(.pred_TOTS)) %>% 

  head(5)
```

```{r serieapredictDEF, echo = FALSE}
serie_a_ranger_test21 %>% 
  filter(position %in% c("LB", "CB", "RB")) %>% 
  arrange(desc(.pred_TOTS)) %>% 
  head(5)
```


```{r echo = FALSE}
new_obs_1 <- prem_ranger_test21 %>% filter(Player == "Kevin De Bruyne") %>% slice(1)

#Pulls together the data needed for the break-down plot
pp_sterling_rf_prem <- predict_parts(explainer = prem_rf_explain,
                          new_observation = new_obs_1,
                          type = "break_down") #default

pp_sterling_rf_la_liga <- predict_parts(explainer = la_liga_rf_explain,
                          new_observation = new_obs_1,
                          type = "break_down") #default

pp_sterling_rf_ligue1 <- predict_parts(explainer = ligue1_rf_explain,
                          new_observation = new_obs_1,
                          type = "break_down") #default

pp_sterling_rf_bundesliga <- predict_parts(explainer = bundesliga_rf_explain,
                          new_observation = new_obs_1,
                          type = "break_down") #default

pp_sterling_rf_serie_a <- predict_parts(explainer = serie_a_rf_explain,
                          new_observation = new_obs_1,
                          type = "break_down") #default

# Break-down plot
sterling_prem_pp <- plot(pp_sterling_rf_prem, title = "Kevin De Bruyne Premier League 2021 Prediction") + theme(plot.title = element_text(hjust = .5, size = 15, color = "black", face = "bold"))

sterling_la_liga_pp <- plot(pp_sterling_rf_la_liga, title = "Kevin De Bruyne La Liga 2021 Prediction") + theme(plot.title = element_text(hjust = .5, size = 15, color = "black", face = "bold"))

sterling_ligue1_pp <- plot(pp_sterling_rf_ligue1, title = "Kevin De Bruyne Ligue 1 2021 Prediction") + theme(plot.title = element_text(hjust = .5, size = 15, color = "black", face = "bold"))

sterling_bundesliga_pp <- plot(pp_sterling_rf_bundesliga, title = "Kevin De Bruyne Bundesliga 2021 Prediction") + theme(plot.title = element_text(hjust = .5, size = 15, color = "black", face = "bold"))

sterling_serie_a_pp <- plot(pp_sterling_rf_serie_a, title = "Kevin De Bruyne Serie A 2021 Prediction") + theme(plot.title = element_text(hjust = .5, size = 15, color = "black", face = "bold"))


ggdraw() + draw_image("https://resources.premierleague.com/premierleague/photos/players/250x250/p61366.png", x = -.43, y = .4, scale = .18) + 
  draw_plot(sterling_prem_pp)

ggdraw() + draw_image("https://resources.premierleague.com/premierleague/photos/players/250x250/p61366.png", x = .45, y = .4, scale = .18) + 
  draw_plot(sterling_la_liga_pp)

ggdraw() + draw_image("https://resources.premierleague.com/premierleague/photos/players/250x250/p61366.png", x = -.43, y = .4, scale = .18) + 
  draw_plot(sterling_ligue1_pp)

ggdraw() + draw_image("https://resources.premierleague.com/premierleague/photos/players/250x250/p61366.png", x = -.43, y = .4, scale = .18) + 
  draw_plot(sterling_bundesliga_pp)

ggdraw() + draw_image("https://resources.premierleague.com/premierleague/photos/players/250x250/p61366.png", x = -.43, y = .4, scale = .18) + 
  draw_plot(sterling_serie_a_pp)
  
```

![Serie A Team of the Season](SerieA_TOTS.jpg)







\
\










## All Leagues Combined (and why it does not work)












