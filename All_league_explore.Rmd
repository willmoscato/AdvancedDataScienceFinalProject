---
title: "FinalProject"
author: "Will Moscato"
date: "4/13/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(tidymodels)
library(lubridate)
library(vip)
library(stacks)
library(DALEX)
library(DALEXtra)
```

```{r}
fifa19_modeling <- fifa19_modeling %>%
  mutate(Player = paste(Player, '19'))

fifa18_modeling <- fifa18_modeling %>%
  mutate(Player = paste(Player, '18'))

fifa17_modeling <- fifa17_modeling %>%
  mutate(Player = paste(Player, '17'))

prem_modeling <- fifa19_modeling %>%
  rbind(fifa18_modeling) %>%
  rbind(fifa17_modeling) %>%
  mutate(revision = as.factor(revision), Nation = as.factor(Nation),
         league = 'prem')
```

```{r}
fifa19_modeling_bundesliga2 <- fifa19_modeling_bundesliga %>%
  mutate(Player = paste(Player, '19'))

fifa18_modeling_bundesliga2 <- fifa18_modeling_bundesliga %>%
  mutate(Player = paste(Player, '18'))

fifa17_modeling_bundesliga2 <- fifa17_modeling_bundesliga %>%
  mutate(Player = paste(Player, '17'))



bundesliga_modeling <- fifa17_modeling_bundesliga2%>% 
  bind_rows(fifa18_modeling_bundesliga2, fifa19_modeling_bundesliga2) %>% 
  mutate(revision = as.factor(revision), Nation = as.factor(Nation),
         league = 'bundesliga')
```

```{r}
fifa19_modeling_la_liga2 <- fifa19_modeling_la_liga %>%
  mutate(Player = paste(Player, '19'))

fifa18_modeling_la_liga2 <- fifa18_modeling_la_liga %>%
  mutate(Player = paste(Player, '18'))

fifa17_modeling_la_liga2 <- fifa17_modeling_la_liga %>%
  mutate(Player = paste(Player, '17'))



la_liga_modeling <- fifa17_modeling_la_liga2%>% 
  bind_rows(fifa18_modeling_la_liga2, fifa19_modeling_la_liga2) %>%
  select(-Starts) %>%
  mutate(revision = as.factor(revision), Nation = as.factor(Nation),
         league = 'la liga')
```

```{r}
fifa19_modeling_serie_a2 <- fifa19_modeling_serie_a %>%
  mutate(Player = paste(Player, '19'))

fifa18_modeling_serie_a2 <- fifa18_modeling_serie_a %>%
  mutate(Player = paste(Player, '18'))

fifa17_modeling_serie_a2 <- fifa17_modeling_serie_a %>%
  mutate(Player = paste(Player, '17'))



serie_a_modeling <- fifa17_modeling_serie_a2%>% 
  bind_rows(fifa18_modeling_serie_a2, fifa19_modeling_serie_a2) %>% 
  mutate(revision = as.factor(revision), Nation = as.factor(Nation),
         league = 'serie a')
```

```{r}
fifa19_modeling_ligue12 <- ligue1_fifa19_modeling %>%
  mutate(Player = paste(Player, '19'))

fifa18_modeling_ligue12 <- ligue1_fifa18_modeling %>%
  mutate(Player = paste(Player, '18'))

fifa17_modeling_ligue12 <- ligue1_fifa17_modeling %>%
  mutate(Player = paste(Player, '17'))



ligue1_modeling <- fifa17_modeling_ligue12%>% 
  bind_rows(fifa18_modeling_ligue12, fifa19_modeling_ligue12) %>% 
  mutate(revision = as.factor(revision), Nation = as.factor(Nation),
         league = 'ligue 1')
```

```{r}
dim(ligue1_modeling)
dim(serie_a_modeling)
dim(la_liga_modeling)
dim(prem_modeling)
dim(bundesliga_modeling)
```

```{r}
all_leagues_modeling <- prem_modeling %>%
  rbind(bundesliga_modeling, la_liga_modeling, serie_a_modeling, ligue1_modeling)
```

```{r}
'%ni%' <- Negate('%in%')

all_modeling_outfield <- all_leagues_modeling %>% 
  filter(position != "GK") %>% 
  filter(MP > 19) %>%
  mutate(points = Gls + Ast) %>%
  mutate(position = ifelse(position == "RWB", "RB", ifelse(position == "LWB", "LB", position))) %>% 
  mutate(position = ifelse(position == 'CF', 'ST', position)) %>%
  mutate(position = as.factor(position)) %>%
  select(-Goals_allowed, -GA90, -SoTA, -Saves, -Save_percent, -W, -L, -D, -CS, -CS_percent, -Pkatt_against, -PKA, -PKsv, -Pk_Save_percent, -PKm, -Born, -Rk, -G_plus_A_minus_PK_per90, -G_plus_A_per90, -G_per90, -A_per90, -G_minus_Pk_per90, -minutes_played_divided_by90)
```

```{r}
all_modeling_outfield <- all_modeling_outfield %>%
  add_n_miss() %>%
  filter(n_miss_all == 0) %>%
  select(-n_miss_all)
```

```{r}
set.seed(494)
all_split <- initial_split(all_modeling_outfield, prop = .75, strata = "revision")
all_training <- training(all_split)
all_testing <- testing(all_split)
```

```{r}
all_lasso_recipe <- recipe(revision ~ . , data = all_training) %>% 
  step_rm(Player, Squad, Nation, league, Attendance) %>%
  step_upsample(revision, over_ratio = .33) %>% 
  step_normalize(all_predictors(),
                 -all_nominal()) %>% 
  step_dummy(all_nominal(),
             -all_outcomes())

all_lasso_recipe %>% 
  prep(all_training) %>% 
  juice()
```

```{r}
all_lasso <- logistic_reg(mixture = 1) %>% 
  set_engine("glmnet") %>% 
  set_args(penalty = tune()) %>% 
  set_mode("classification")

all_lasso_wf <- 
  workflow() %>% 
  add_recipe(all_lasso_recipe) %>% 
  add_model(all_lasso)
```

```{r}
set.seed(494) # for reproducibility
all_cv <- vfold_cv(all_training, v = 5)

penalty_grid <- grid_regular(penalty(),
                             levels = 10)

all_lasso_tune <- 
  all_lasso_wf %>% 
  tune_grid(
    resamples = all_cv,
    grid = penalty_grid
    )
```

```{r}
best <- all_lasso_tune %>% 
  select_best(metric = "accuracy")
```

```{r}
all_lasso_final_wf <- all_lasso_wf %>% 
  finalize_workflow(best)
```

```{r}
all_lasso_final_mod <- all_lasso_final_wf %>% 
  fit(data = all_training)

all_lasso_final_mod %>% 
  pull_workflow_fit() %>% 
  tidy() 
```

```{r}
all_lasso_final_mod %>% 
  pull_workflow_fit() %>% 
  vip()
```

```{r}
all_lasso_test <- all_lasso_final_wf %>% 
  last_fit(all_split)

all_lasso_test %>% 
  collect_metrics()
```

```{r}
preds <- all_lasso_test %>% 
  collect_predictions()

preds %>% 
  conf_mat(revision, .pred_class)
```

```{r}
lasso_test <- all_testing %>% 
  bind_cols(predict(all_lasso_final_mod, new_data = all_testing, type = "prob")) %>% 
  bind_cols(predict(all_lasso_final_mod, new_data = all_testing)) 
```

```{r}
lasso_test %>% 
  filter(.pred_class != revision) %>%
  select(Player, revision, .pred_class, position, .pred_TOTS, league) %>%
  group_by(league) %>%
  summarise(total = n()) %>%
  arrange(desc(total))
```

```{r prem table}
lasso_test %>%
  filter(league == 'prem') %>%
  arrange(desc(.pred_TOTS))
```

```{r}
all_ranger_recipe <- recipe(revision ~., data = all_training) %>% 
  step_rm(Player, Squad, Nation, league, Attendance) %>% 
  step_upsample(revision, over_ratio = .33) %>% 
  step_mutate_at(all_numeric(), fn = ~as.numeric(.))

all_ranger_recipe %>% 
  prep(all_training) %>% 
  juice()
```


```{r}
all_ranger <- rand_forest(mtry = tune(), 
              min_n = tune(), 
              trees = 100) %>% 
  set_mode("classification") %>% 
  set_engine("ranger")

all_ranger_wf <- 
  workflow() %>% 
  add_recipe(all_ranger_recipe) %>% 
  add_model(all_ranger) 

all_ranger_wf
```

```{r}
set.seed(494)
all_split <- initial_split(all_modeling_outfield, prop = .75, strata = "revision")
all_training <- training(all_split)
all_testing <- testing(all_split)
```

```{r}
set.seed(494)
all_cv <- vfold_cv(all_training, v = 5)

all_rf_grid <- grid_regular(min_n(), finalize(mtry(), all_training %>% select(-revision)), levels = 3)

all_ctrl_res <- control_stack_grid()

all_ranger_cv <- all_ranger_wf %>% 
  tune_grid(resamples = all_cv,
           grid = all_rf_grid,
           control = all_ctrl_res)

collect_metrics(all_ranger_cv)
```


```{r}
all_best1 <- all_ranger_cv %>% 
  select_best(metric = "accuracy")

all_ranger_final_wf<- all_ranger_wf %>% 
  finalize_workflow(all_best1)
```

```{r}
all_ranger_fit <- all_ranger_final_wf %>% 
  fit(all_training)


all_rf_explain <- 
  explain_tidymodels(
    model = all_ranger_fit,
    data = all_training %>% select(-revision), 
    y = as.numeric(all_training$revision == "TOTS"),
    label = "rf"
  )
```

```{r}
all_rf_var_imp <- 
  model_parts(
    all_rf_explain
    )

plot(all_rf_var_imp)
```


```{r}
all_ranger_test <- all_ranger_final_wf %>% 
  last_fit(all_split)

all_ranger_test %>% 
  collect_metrics()
```

```{r}
all_preds1 <- all_ranger_test %>% 
  collect_predictions()

all_preds1 %>% 
  conf_mat(revision, .pred_class)
```

```{r}
all_ranger_test <- all_testing %>% 
  bind_cols(predict(all_ranger_fit, new_data = all_testing, type = "prob")) %>% 
  bind_cols(predict(all_ranger_fit, new_data = all_testing)) 
```

```{r}
all_ranger_test %>% 
  conf_mat(revision, .pred_class)
```

```{r}
all_ranger_test %>% 
  filter(.pred_class != revision) %>%
  select(Player, revision, .pred_class, position, .pred_TOTS, league) %>%
  group_by(league) %>%
  summarise(total = n()) %>%
  arrange(desc(total))
```
